#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
CERTS_DIR="${ROOT_DIR}/.certs"

rm -rf "${CERTS_DIR}"
mkdir -p "${CERTS_DIR}"

WEBHOOK_NAME="${WEBHOOK_NAME:-gitlab-workspaces-kubernetes-webhook}"
WEBHOOK_NAMESPACE="${WEBHOOK_NAMESPACE:-default}"

openssl genrsa -out "${CERTS_DIR}/ca.key" 2048

openssl req -new -x509 -days 365 -key "${CERTS_DIR}/ca.key" \
  -subj "/C=AU/CN=${WEBHOOK_NAME}" \
  -out "${CERTS_DIR}/ca.crt"

openssl req -newkey rsa:2048 -nodes -keyout "${CERTS_DIR}/server.key" \
  -subj "/C=AU/CN=${WEBHOOK_NAME}" \
  -out "${CERTS_DIR}/server.csr"

openssl x509 -req \
  -extfile <(printf "subjectAltName=DNS:${WEBHOOK_NAME}.${WEBHOOK_NAMESPACE}.svc") \
  -days 365 \
  -in "${CERTS_DIR}/server.csr" \
  -CA "${CERTS_DIR}/ca.crt" -CAkey "${CERTS_DIR}/ca.key" -CAcreateserial \
  -out "${CERTS_DIR}/server.crt"

echo
echo ">> Generating kube secrets..."
kubectl --namespace "${WEBHOOK_NAMESPACE}" create secret tls "${WEBHOOK_NAME}-tls" \
  --cert="${CERTS_DIR}/server.crt" \
  --key="${CERTS_DIR}/server.key" \
  --dry-run=client -o yaml \
  > "${SCRIPT_DIR}/manifests/webhook/webhook.tls.secret.yaml"

echo
echo ">> Encoding and injecting caBundle..."

# Generate base64-encoded CA bundle and indent each line with 6 spaces
CA_B64=$(base64 -w0 < "${CERTS_DIR}/ca.crt" | fold -w64 | sed 's/^/      /')

for yaml in \
  "${ROOT_DIR}/dev/manifests/cluster-config/mutating.config.yaml" \
  "${ROOT_DIR}/dev/manifests/cluster-config/validating.config.yaml"
do
  echo ">> Updating $yaml"

  awk -v ca_bundle="$CA_B64" '
    BEGIN { replacing = 0 }
    {
      if ($0 ~ /caBundle:[[:space:]]*\|/) {
        print $0
        replacing = 1
        next
      }
      if (replacing) {
        if ($0 ~ /^[^[:space:]]/) {
          replacing = 0
          print ca_bundle
        }
        else {
          next
        }
      }
      if (!replacing) print $0
    }
    END {
      if (replacing) print ca_bundle
    }
  ' "$yaml" > "$yaml.tmp" && mv "$yaml.tmp" "$yaml"
done

echo
echo ">> Clean up temp certs"
rm -rf "${CERTS_DIR}"
